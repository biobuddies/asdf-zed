#!/usr/bin/env bash

set -euo pipefail

mkdir -p "$ASDF_INSTALL_PATH"

download="https://github.com/zed-industries/zed/releases/download/v$ASDF_INSTALL_VERSION"

(
    case "$(uname -s)" in
        Darwin)
            arch="$(uname -m | sed s/arm64/aarch64/)"
            hdiutil attach -nobrowse -quiet "$download/Zed-$arch.dmg"
            cp -a /Volumes/Zed/Zed.app "$ASDF_INSTALL_PATH/"
            hdiutil detach -quiet /Volumes/Zed
            mkdir "$ASDF_INSTALL_PATH/bin"
            cat >"$ASDF_INSTALL_PATH/bin/zed" <<EOD
#!/usr/bin/env bash
$ASDF_INSTALL_PATH/Zed.app/Contents/MacOS/zed
EOD
            chmod +x "$ASDF_INSTALL_PATH/bin/zed"
            ;;
        Linux)
            set -x
            curl \
                --fail \
                --header "$(
                    [[ ${GITHUB_API_TOKEN-} ]] && echo Authorization: token $GITHUB_API_TOKEN
                )" \
                --location \
                --show-error \
                --silent \
                "$download/zed-linux-$(uname -m).tar.gz" \
                | tar \
                    --directory "$ASDF_INSTALL_PATH" \
                    --extract \
                    --gzip \
                    --strip-components=1
            ;;
        *)
            fail "$(uname -s) is unsupported"
            ;;
    esac
) && exit 0

echo "asdf-zed: Error installing $ASDF_INSTALL_VERSION"
exit 1
